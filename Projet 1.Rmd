---
title: "Time Series Project"
author: "Aurore Pont and Alexia Duclert"
date: "2024-05-18"
output:
  pdf_document: default
  html_document: default
---
```{r}
install.packages('dplyr')
library(dplyr)

install.packages('zoo')
library(zoo)

install.packages('tseries')
library(tseries)

install.packages('tidyr')
library(tidyr)

library(ggplot2)

install.packages('fUnitRoots')
library(fUnitRoots)

```

```{r}
head(caractéristiques)
```

```{r}
head(valeurs_mensuelles)
```

```{r}
valeurs_mensuelles <- tail(valeurs_mensuelles, -3)
names(valeurs_mensuelles)[1] <- "V1"  
valeurs_mensuelles <- separate(valeurs_mensuelles, col = V1, into = c("date", "value", "characteristic"), sep = ";")
head(valeurs_mensuelles)
```


```{r}

dates <- as.yearmon(seq(from=1990,to=2024+2/12,by=1/12))
value <- zoo(valeurs_mensuelles$value,order.by=rev(dates))
plot(value,ylim=c(0,800),main="CVS-CJO industrial production index - Hydrocarbon extraction")

```

#ARIMA modelling of a time series

##Part I : the data

### 1. What does the chosen series represent ? (sector, potential data processing, logarithmic transformation, etc.)


### 2. Transform the series to make it stationary if necessary (differentiate it, correct the deterministic trend, etc.). Thoroughly justify your choices.


#The logarithmic transformation, Yt = logXt for Xt > 0, may allow to reduce some nonlinearities

```{r}
valeurs_mensuelles$log_value <- zoo(log(as.numeric(valeurs_mensuelles$value)),order.by=rev(dates))
plot(valeurs_mensuelles$log_value, ylim=c(4,7),main="CVS-CJO industrial production log(index) - Hydrocarbon extraction")

```
On remarque que c'est pas stationnaire => on doit la stationnariser avec par ex l'outil de first diff + on remarque pas de saisonalité

```{r}
diff <- diff(valeurs_mensuelles$log_value,1)
plot(diff,ylim=c(-0.7,0.7),main="CVS-CJO industrial production difflog(index) - Hydrocarbon extraction")

```
```{r}
kpss.test(valeurs_mensuelles$log_value, null="Level")
```
C'est cool on a 1%

```{r}
kpss.test(diff, null="Level")
```
On a 10%


```{r}
adf <- adfTest(valeurs_mensuelles$log_value)
adf
```
test rejeté au seuil 5%


On fait le même test sur la série différenciée :
```{r}
adf <- adfTest(diff)
adf
```
Test accepté au seuil 5%


### Partie 2

```{r}
acf(diff,15)
pacf(diff,15)
```
ARMA(p,q) a l'air de bien fitter
ACF -> q = 0, 1, 2
PACF -> p = 0, 1, 2, 3, 4

```{r}
arma00 <- arima(diff,c(0,0,0))
arma01 <- arima(diff,c(0,0,1))
arma02 <- arima(diff,c(0,0,2))

arma10 <- arima(diff,c(1,0,0))
arma11 <- arima(diff,c(1,0,1))
arma12 <- arima(diff,c(1,0,2))

arma20 <- arima(diff,c(2,0,0))
arma21 <- arima(diff,c(2,0,1))
arma22 <- arima(diff,c(2,0,2))

arma30 <- arima(diff,c(3,0,0))
arma31 <- arima(diff,c(3,0,1))
arma32 <- arima(diff,c(3,0,2))

arma40 <- arima(diff,c(4,0,0))
arma41 <- arima(diff,c(4,0,1))
arma42 <- arima(diff,c(4,0,2))
```


```{r}
Qtests <- function(series, k, fitdf=0) {
pvals <- apply(matrix(1:k), 1, FUN=function(l) {
pval <- if (l<=fitdf) NA else Box.test(series, lag=l, type="Ljung-Box", fitdf=fitdf)$p.value
return(c("lag"=l,"pval"=pval))
})
return(t(pvals))
}
Qtests(arma21$residuals, 24, 3)
```
On voit avec les autocorrelations qu'on peut conserver ARMA(0,2), ARMA(1,2), ARMA(2,1), ARMA(2,2), ARMA(3,1), ARMA(3,2), ARMA(4,1) et ARMA(4,2)
```{r}
signif <- function(estim){coef <- estim$coef
se <- sqrt(diag(estim$var.coef))
t <- coef/se
pval <- (1-pnorm(abs(t)))*2
return(rbind(coef,se,pval))}

signif(arma02)
```

En regardant la significativité des coefficients, on garde MA(2), ARMA(1,2) et ARMA(2,1).


```{r}
arimafit <- function(estim){
adjust <- round(signif(estim),3)
pvals <- Qtests(estim$residuals,24,length(estim$coef)-1)
pvals <- matrix(apply(matrix(1:24,nrow=6),2,function(c) round(pvals[c,],3)),nrow=6)
colnames(pvals) <- rep(c("lag", "pval"),4)
cat("coefficients nullity tests :\n")
print(adjust)
cat("\n tests of autocorrelation of the residuals : \n")
print(pvals)}
```


```{r}
estimation <- arma21
arimafit(estimation)
ar2ma1 <- estimation
```
```{r}
estimation <- arma12
arimafit(estimation)
ar1ma2 <- estimation
```

```{r}
estimation <- arma02; arimafit(estimation)
ma2 <- estimation
```

```{r}
models <- c("ma2","ar1ma2","ar2ma1"); names(models) <- models
apply(as.matrix(models),1, function(m) c("AIC"=AIC(get(m)), "BIC"=BIC(get(m))))
```
Le AIC le plus faible est celui de ARMA(1,2) et le BIC le plus faible est celui de MA(2).
```{r}
# Différence des AIC :
-1095.129 - (-1097.910)
# Différence des BIC
-1077.829 - (-1079.064)
```
La différence des AIC est plus élevée, on conserve donc ARMA(1,2).


```{r}
estimation <- arima(valeurs_mensuelles$log_value,c(1,1,2))
arimafit(estimation)
```
On voit que le modèle fit bien avec un SARIMA(1,1,2).


### Partie 3



